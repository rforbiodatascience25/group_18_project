---
title: "06_analysis_2"
author:
  - "Kacper Maciejewski (s243548)"
  - "Sofia Russo (252054)"
  - "Aleksandra Wozniak (253713)"
  - "Gabriel Loayza (252608)"
  - "Dagmar Geevers (252256)"
format:
  html:
    embed-resources: true
editor: visual
---

## Load Libraries

```{r}
library(tidyverse)
library(broom)
library(patchwork)
```

## Load data

```{r}
my_data <- read_csv("../data/02_dat_clean.csv", show_col_types = FALSE)
#view(my_data)
```

## 1. Filtering only the samples with mRNAsi

```{r}
data_for_stemness <- my_data %>% drop_na(mRNAsi)
```

## 2. Standardization of tumor names

```{r}
data_for_stemness$Cancer <- dplyr::recode(data_for_stemness$Cancer,
  "blca_tcga_pan_can_atlas_2018"    = "BLCA",
  "brca_tcga_pan_can_atlas_2018"    = "BRCA",
  "cesc_tcga_pan_can_atlas_2018"    = "CESC",
  "coadread_tcga_pan_can_atlas_2018"= "COAD",
  "esca_tcga_pan_can_atlas_2018"    = "ESCA",
  "gbm_tcga_pan_can_atlas_2018"     = "GBM",
  "hnsc_tcga_pan_can_atlas_2018"    = "HNSC",
  "kirc_tcga_pan_can_atlas_2018"    = "KIRC",
  "kirp_tcga_pan_can_atlas_2018"    = "KIRP",
  "lgg_tcga_pan_can_atlas_2018"     = "LGG",
  "lihc_tcga_pan_can_atlas_2018"    = "LIHC",
  "luad_tcga_pan_can_atlas_2018"    = "LUAD",
  "lusc_tcga_pan_can_atlas_2018"    = "LUSC",
  "ov_tcga_pan_can_atlas_2018"      = "OV",
  "paad_tcga_pan_can_atlas_2018"    = "PAAD",
  "prad_tcga_pan_can_atlas_2018"    = "PRAD",
  "sarc_tcga_pan_can_atlas_2018"    = "SARC",
  "skcm_tcga_pan_can_atlas_2018"    = "SKCM",
  "stad_tcga_pan_can_atlas_2018"    = "STAD",
  "tgct_tcga_pan_can_atlas_2018"    = "TGCT",
  "thca_tcga_pan_can_atlas_2018"    = "THCA",
  "ucec_tcga_pan_can_atlas_2018"    = "UCEC"
)

cancers_use_stemness <- unique(data_for_stemness$Cancer)
```

## 3. Selection of genes for analysis

```{r}
genes_to_test_stemness <- c(
  "HDAC4", "HDAC5", "HDAC9", "HDAC7", # class IIA
  "HDAC10", "HDAC6",                  # class IIB
  "SIRT5", "SIRT7", "SIRT6", "SIRT3", "SIRT4", "SIRT2", "SIRT1", # class III
  "HDAC11",                           # class IV
  "HDAC2", "HDAC3", "HDAC8", "HDAC1"  # class I
)
```

## 4. Computation of Spearman correlations between gene expression and mRNAsi.

Steps: reshape data, group by Cancer and gene, run cor.test, extract rho (correlation) and p-value.

```{r}
s_correlation_stemness <- data_for_stemness %>%
  pivot_longer(cols = any_of(genes_to_test_stemness),
               names_to = "gene", values_to = "expression") %>%
  group_by(Cancer, gene) %>%
  summarize(summary_test = broom::tidy(cor.test(expression, mRNAsi, method = "spearman", exact = FALSE)),
            .groups = "drop") %>%
  unnest(summary_test) %>%
  select(Cancer, gene, rho = estimate, p.value)
```

## 5. Adjustment p-values using Benjamini–Hochberg (BH) correction to control false positives.

Create a "label" column with symbols showing significance levels.

```{r}
s_correlation_stemness <- s_correlation_stemness %>%
  mutate(p.adj = p.adjust(p.value, method = "BH"),
         label = case_when(
           p.adj < 0.001 ~ "■",
           p.adj < 0.01  ~ "▲",
           p.adj < 0.05  ~ "•",
           TRUE ~ ""
         ))
```

## 6. Definition of gene classes (I, IIA, IIB, III, IV) and assignment of each geneto its corresponding family.

Creation a data frame (annot_df) linking genes to HDAC/SIRT classes for annotation in the heatmap.

```{r}
gene_classes <- c(
  HDAC3="class I", HDAC2="class I", HDAC1="class I", HDAC8="class I",
  HDAC7="class IIA", HDAC9="class IIA", HDAC5="class IIA", HDAC4="class IIA",
  SIRT1="class III", SIRT7="class III", SIRT6="class III", SIRT4="class III",
  SIRT3="class III", SIRT2="class III", SIRT5="class III",
  HDAC6="class IIB", HDAC10="class IIB", HDAC11="class IV"
)

annot_df <- data.frame(
  gene = genes_to_test_stemness,
  HDAC_family = gene_classes[genes_to_test_stemness]
)
```

## 7. Creation of the heatmap of Spearman correlations (rho) between gene expression and mRNAsi.

-   x-axis: Cancer types
-   y-axis: Genes (ordered, reversed for display)
-   fill color: correlation coefficient (blue = negative, red = positive)
-   overlay symbols (■, ▲, •) showing significance levels

```{r}
p_heatmap <- ggplot(s_correlation_stemness,
                    aes(x = Cancer,
                        y = factor(gene, levels = rev(genes_to_test_stemness)),
                        fill = rho)) +
  geom_tile(color = "white", size = 0.2) +
  geom_text(aes(label = label), size = 3, vjust = 0.75) +
  scale_fill_gradientn(colors = colorRampPalette(c("blue", "white", "red"))(101),
                       limits = c(-0.7, 0.8),
                       name = "rho value") +
  scale_y_discrete(expand = c(0, 0), position = "right") +
  scale_x_discrete(expand = c(0, 0)) +
  theme_minimal(base_size = 7) +
  theme(
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1, color = "black"),
    axis.text.y = element_text(color = "black"),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = margin(t = 5.5, r = 5.5, b = 5.5, l = 0),
    legend.position = "right"
  ) +
  labs(title = "mRNAsi vs HDAC expression in TCGA tumors")
```

## 8. Creation of the annotation panel showing gene classes (HDAC families).

Each gene is displayed as a tile, colored by its family (I, IIA, IIB, III, IV).

```{r}
p_annot <- ggplot(annot_df, aes(
    x = 1,
    y = factor(gene, levels = rev(genes_to_test_stemness)),
    fill = HDAC_family)) +
  geom_tile() +
  scale_fill_manual(values = c(
    "class I"="salmon",
    "class IIA"="#E69F52",
    "class IIB"="#BDB600",
    "class III"="#009E60",
    "class IV"="#008ECE")) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_x_continuous(expand = c(0, 0)) +
  labs(y = "HDAC family", fill = "HDAC family") +
  theme_void() +
  theme(plot.margin = margin(t = 5.5, r = 0, b = 5.5, l = 5.5))
```

## 9. Combine annotation panel and heatmap into one figure.

Show the plot and save it as PNG.

```{r}
final_plot <- p_annot + p_heatmap + plot_layout(widths = c(1, 20), guides = "collect")
final_plot
ggsave("../results/heatmap_stemness.png", plot = final_plot, width = 8, height = 6, dpi = 300)

```
