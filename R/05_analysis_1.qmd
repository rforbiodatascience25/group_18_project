---
title: "05_analysis_1"
author:
  - "Kacper Maciejewski (s243548)"
  - "Sofia Russo (252054)"
  - "Aleksandra Wozniak (253713)"
  - "Gabriel Loayza (252608)"
  - "Dagmar Geevers (252256)"
format:
  html:
    embed-resources: true
editor: visual
---

## Load data

```{r}
my_data <- read_csv("../data/02_dat_clean.csv")
#view(my_data)
```

## Load libraries

```{r}
#rm(list=ls())
library(tidyverse)
library(ggplot2)
library(tidyr)
library(broom)
library(grid)
library(patchwork)

```

# FIGURE 1A

## 1.1 Cleaning and numbering the "Grade"

Grade is a microscopic assessment of the appearance of cancer cells, indicating how different they are from the normal cells.

-   low grade- the cells are similar to healthy ones. The tumor is usually less agressive

-   high grade- the cells are poorly differentiated or undifferentiated. The tumor is usually more agressive

```{r}
print(unique(my_data$Grade))
#convert descriptive text values to numierc values to enable statistical calculations
changed_data <- my_data %>% 
  mutate(
    Grade_in_numbers = case_when(
#group 1: low malignacy
      Grade == "G1" ~ 1,
      Grade == "Low Grade" ~ 1,
#group 2: medium malignacy
      Grade == "G2" ~ 2,
#group 3: high malignacy
      Grade == "G3" ~ 3,
      Grade == "High Grade" ~ 3,
#group 4: the highest malignacy
      Grade == "G4" ~ 4,
      TRUE ~ NA_real_
    )
  ) %>% 
  drop_na(Grade_in_numbers)
print(changed_data$Grade_in_numbers)
```

## 1.2 Standardization of tumor names

-   long names from TCGA database are converted to short abbreviations

```{r}
changed_data$Cancer <- dplyr::recode(changed_data$Cancer,
  "blca_tcga_pan_can_atlas_2018"    = "BLCA",
  "brca_tcga_pan_can_atlas_2018"    = "BRCA",
  "cesc_tcga_pan_can_atlas_2018"    = "CESC",
  "coadread_tcga_pan_can_atlas_2018"= "COAD",
  "esca_tcga_pan_can_atlas_2018"    = "ESCA",
  "gbm_tcga_pan_can_atlas_2018"     = "GBM",
  "hnsc_tcga_pan_can_atlas_2018"    = "HNSC",
  "kirc_tcga_pan_can_atlas_2018"    = "KIRC",
  "kirp_tcga_pan_can_atlas_2018"    = "KIRP",
  "lgg_tcga_pan_can_atlas_2018"     = "LGG",
  "lihc_tcga_pan_can_atlas_2018"    = "LIHC",
  "luad_tcga_pan_can_atlas_2018"    = "LUAD",
  "lusc_tcga_pan_can_atlas_2018"    = "LUSC",
  "ov_tcga_pan_can_atlas_2018"      = "OV",
  "paad_tcga_pan_can_atlas_2018"    = "PAAD",
  "prad_tcga_pan_can_atlas_2018"    = "PRAD",
  "sarc_tcga_pan_can_atlas_2018"    = "SARC",
  "skcm_tcga_pan_can_atlas_2018"    = "SKCM",
  "stad_tcga_pan_can_atlas_2018"    = "STAD",
  "tgct_tcga_pan_can_atlas_2018"    = "TGCT",
  "thca_tcga_pan_can_atlas_2018"    = "THCA",
  "ucec_tcga_pan_can_atlas_2018"    = "UCEC"
)

#next step: filtering the data, leaving only the selected cancer types and arranges them in order on the graph
cancer_order <- c(
  "LIHC", "UCEC", "KIRC", "LGG",
  "OV", "PAAD",
  "HNSC", "ESCA", "CESC", "STAD",
  "COAD", "BLCA"
)
cancers_use <- intersect(cancer_order, unique(changed_data$Cancer))

changed_data <- changed_data %>%
  filter(Cancer %in% cancers_use)

changed_data$Cancer <- factor(changed_data$Cancer,
                              levels = cancers_use)
```

## 1.3 Selection of genes for analysis

```{r}
genes_to_test <- c(
#class I
  "HDAC3", "HDAC2", "HDAC1", "HDAC8",
#class IIA
  "HDAC7", "HDAC9", "HDAC5", "HDAC4",
#class III
  "SIRT1", "SIRT7", "SIRT6", "SIRT4", "SIRT3", "SIRT2", "SIRT5",
#class IIB
  "HDAC6", "HDAC10",
#class IV
  "HDAC11")

```

## 1.4 Statistical calculations- correlation

We want to see how the activity of gene "x" in patients with cancer "y" correlates with increasing malignancy.

For that we are using Spearman correlation, because it is resistant for asymmetry.

The result is the correlation coefficient ( rho) and statistical significance ( p value)

```{r}
#pivot_longer- this function changes format from wide to long format
s_correlation <- changed_data %>% 
  pivot_longer(
    cols = any_of(genes_to_test),
    names_to = "gene",
    values_to = "expression"
  ) %>% 
  #group for each pair (gene + cancer)
group_by(Cancer, gene) %>% 
summarize(
    summary_test = broom::tidy(cor.test(expression, Grade_in_numbers, method ="spearman")), .groups = "drop"
  ) %>% 
  unnest(summary_test) %>% 
  select(Cancer, gene, rho = estimate, p.value)

```

## 1.5 Matrix_rho

heatmap requires data in matrix format

```{r}
matrix_rho <- s_correlation %>% 
  select(gene, Cancer, rho) %>% 
  pivot_wider(
    names_from = Cancer,
    values_from = rho
  ) %>% 
  column_to_rownames("gene") %>% 
  as.matrix()
```

## 1.6 Matrix_p

```{r}
matrix_p <- s_correlation %>% 
  select(gene, Cancer, p.value) %>% 
  pivot_wider(
    names_from = Cancer,
    values_from = p.value
  ) %>% 
  column_to_rownames("gene") %>% 
  as.matrix()

#filtering and sorting- without that R will sort the genes by alphabet 
final_genes <- genes_to_test[genes_to_test %in% rownames(matrix_rho)]
final_cancers <- cancers_use[cancers_use %in% colnames(matrix_rho)]

#sorted versions
matrix_rho <- matrix_rho[final_genes, final_cancers, drop = FALSE]
matrix_p   <- matrix_p[final_genes, final_cancers, drop = FALSE]

#NA -> 0
matrix_rho_plot <- matrix_rho
matrix_rho_plot[is.na(matrix_rho_plot)] <- 0
```

## 1.7 Preparation of the final graph

```{r}
#adnotations-> annot_row creates a legend, assignment to classes
#data frame is created assigning each gene to the appropriate family
gene_classes <- c(
  HDAC3="class I",
  HDAC2="class I",
  HDAC1="class I",
  HDAC8="class I",

  HDAC7="class IIA",
  HDAC9="class IIA",
  HDAC5="class IIA",
  HDAC4="class IIA",
  
  HDAC6="class IIB",
  HDAC10="class IIB",
  
  SIRT1="class III",
  SIRT7="class III",
  SIRT6="class III",
  SIRT4="class III",
  SIRT3="class III",
  SIRT2="class III",
  SIRT5="class III",
  
  HDAC11="class IV"
)
#data frame for heatmap
annot_df <- data.frame(
  gene = final_genes,
  HDAC_family = gene_classes[final_genes]
)

#a BH correction is applied to the p-values to avoid false positives with multiple tests
matrix_p_dot <- matrix(p.adjust(as.vector(matrix_p), method = "BH"),
                       ncol = ncol(matrix_p),
                       nrow = nrow(matrix_p),
                       byrow = FALSE
)
#adding markers depending on p value
display_matrix <- 
  ifelse(matrix_p_dot < 0.001, "■",
  ifelse(matrix_p_dot < 0.01,  "▲",
  ifelse(matrix_p_dot < 0.05,  "•", "")))


#color palette
my_breaks <- seq(-0.3, 0.3, length.out = 100)

my_colours <- colorRampPalette(c("blue","white", "red"))(100)


# data preparation for ggplot 
df_long <- matrix_rho_plot %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  pivot_longer(-gene, names_to = "Cancer", values_to = "value")

df_long$Cancer <- factor(df_long$Cancer, levels = cancer_order)

df_long$label <- as.character(display_matrix)


#adnotations panel
p_annot <- ggplot(annot_df, aes(
    x=1,
    y=factor(gene, levels=rev(final_genes)),
    fill=HDAC_family)) +
  geom_tile() +
  scale_fill_manual(values=c(
    "class I"="salmon",
    "class IIA"="#E69F52",
    "class IIB"="#BDB600",
    "class III"="#009E60",
    "class IV"="#008ECE")) +
  scale_y_discrete(expand = c(0, 0)) + 
  scale_x_continuous(expand = c(0, 0)) +
  labs(y = "HDAC family", fill = "HDAC family") +
  theme_void() +
  theme(
    plot.margin = margin(t = 5.5, r = 0, b = 5.5, l = 5.5)
    ) +
  labs(fill = "HDAC family")


```

## 1.8 Drawing a graph

From heatmap we can see:

-   Positive numbers - the more malignant the cancer, the more active the gene (red)

-   Negative numbers - when the cancer is more malignant, the gene is less active (blue)

-   Numbers close to 0 - no correlation

-   Matrix_p says how random are the results. On a graph a dot means that the value is small, so the result is certain

```{r}
#heatmap
p_heatmap <- ggplot(df_long,
                    aes(x=Cancer,
                        y=factor(gene, levels=rev(final_genes)),
                        fill=value)) +
  geom_tile(color = "white", size = 0.2) +
  geom_text(aes(label=label), size=3, vjust = 0.75) +
  scale_fill_gradientn(colors=my_colours, limits=c(-0.3,0.3), name = "rho value") + scale_y_discrete(expand = c(0, 0), position = "right") + 
  scale_x_discrete(expand = c(0, 0)) +
  theme_minimal(base_size=7) +
  theme(
    axis.text.x = element_text(angle=90, vjust=0.5, hjust = 1, color = "black"),
    axis.text.y = element_text(color = "black"),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = margin(t = 5.5, r = 5.5, b = 5.5, l = 0),
    legend.position = "right"
  ) +
  labs(title="A: Grade ~ mRNA in TCGA tumors")


#heatmap + adnotations
final_plot <- p_annot + p_heatmap +
  plot_layout(widths = c(1, 20), guides = 'collect') 

final_plot
```

# FIGURE 1B

## 2.1 Cleaning and numbering the "Stage"

```{r}
print(unique(my_data$Stage))
#convert descriptive text values to numierc values to enable statistical calculations
changed_data_for_stage <-my_data %>% 
  mutate( Stage_in_numbers =
            case_when(
            Stage == "STAGE 0" ~ 0,
            Stage == "STAGE IS" ~ 0,
            Stage %in% c("STAGE I", "STAGE IA", "STAGE IB") ~ 1,
            Stage %in% c("STAGE II", "STAGE IIA", "STAGE IIB", "STAGE IIC") ~ 2,
            Stage %in% c("STAGE III", "STAGE IIIA", "STAGE IIIB", "STAGE IIIC") ~ 3,
            Stage %in% c("STAGE IV", "STAGE IVA", "STAGE IVB", "STAGE IVC") ~ 4,
            Stage == "STAGE I/II (NOS)" ~ 1.5,
            Stage == "STAGE X" ~ NA,
            TRUE ~ NA
            )
  )
view(changed_data_for_stage)
```

## 2.2 Standardization of tumor names

-   long names from TCGA database are converted to short abbreviations

```{r}
changed_data_for_stage$Cancer <- dplyr::recode(changed_data_for_stage$Cancer,
  "blca_tcga_pan_can_atlas_2018"    = "BLCA",
  "brca_tcga_pan_can_atlas_2018"    = "BRCA",
  "cesc_tcga_pan_can_atlas_2018"    = "CESC",
  "coadread_tcga_pan_can_atlas_2018"= "COAD",
  "esca_tcga_pan_can_atlas_2018"    = "ESCA",
  "gbm_tcga_pan_can_atlas_2018"     = "GBM",
  "hnsc_tcga_pan_can_atlas_2018"    = "HNSC",
  "kirc_tcga_pan_can_atlas_2018"    = "KIRC",
  "kirp_tcga_pan_can_atlas_2018"    = "KIRP",
  "lgg_tcga_pan_can_atlas_2018"     = "LGG",
  "lihc_tcga_pan_can_atlas_2018"    = "LIHC",
  "luad_tcga_pan_can_atlas_2018"    = "LUAD",
  "lusc_tcga_pan_can_atlas_2018"    = "LUSC",
  "ov_tcga_pan_can_atlas_2018"      = "OV",
  "paad_tcga_pan_can_atlas_2018"    = "PAAD",
  "prad_tcga_pan_can_atlas_2018"    = "PRAD",
  "sarc_tcga_pan_can_atlas_2018"    = "SARC",
  "skcm_tcga_pan_can_atlas_2018"    = "SKCM",
  "stad_tcga_pan_can_atlas_2018"    = "STAD",
  "tgct_tcga_pan_can_atlas_2018"    = "TGCT",
  "thca_tcga_pan_can_atlas_2018"    = "THCA",
  "ucec_tcga_pan_can_atlas_2018"    = "UCEC"
)

  
cancer_order_stage <- c(
  "TGCT", "KIRC", "KIRP", "ESCA",
  "COAD", "LIHC", "HNSC", "BRCA", "LUSC", "SKCM",
  "THCA", "LUAD", "STAD", "BLCA", "PAAD"
)
cancers_use_stage <- intersect(cancer_order_stage, unique(changed_data_for_stage$Cancer))

changed_data_for_stage <- changed_data_for_stage %>%
  filter(Cancer %in% cancers_use_stage)

changed_data_for_stage$Cancer <- factor(changed_data_for_stage$Cancer,
                              levels = cancers_use_stage)


```

## 2.3 Selection of genes for analysis

```{r}
#here i define genes in the order for the graph
genes_to_test_stage <- c(
#class I
  "HDAC8", "HDAC3", "HDAC2", "HDAC1",
#class IV
  "HDAC11",
#class IIB
  "HDAC10", "HDAC6",
#class IIA
  "HDAC7", "HDAC9", "HDAC5", "HDAC4",
#class III
  "SIRT7", "SIRT2", "SIRT6", "SIRT4", "SIRT1", "SIRT3", "SIRT5"

)
```

## 2.4 Statistical calculations- correlation

```{r}
#correlation for each pair
s_correlation_stage <- changed_data_for_stage %>% 
  pivot_longer(
    cols = any_of(genes_to_test_stage),
    names_to = "gene",
    values_to = "expression"
  ) %>% 
  #group for each pair (gene + cancer)
group_by(Cancer, gene) %>% 
summarize(
    summary_test_stage = broom::tidy(cor.test(expression, Stage_in_numbers, method ="spearman", exact = FALSE)), .groups = "drop"
  ) %>% 
  unnest(summary_test_stage) %>% 
  select(Cancer, gene, rho = estimate, p.value)

```

## 2.5 Matrix_rho

```{r}
matrix_rho_stage <- s_correlation_stage %>% 
  select(gene, Cancer, rho) %>% 
  pivot_wider(
    names_from = Cancer,
    values_from = rho
  ) %>% 
  column_to_rownames("gene") %>% 
  as.matrix()
```

## 2.6 Matrix_p

```{r}
matrix_p_stage <- s_correlation_stage %>% 
  select(gene, Cancer, p.value) %>% 
  pivot_wider(
    names_from = Cancer,
    values_from = p.value
  ) %>% 
  column_to_rownames("gene") %>% 
  as.matrix()

#filtering and sorting- without that R will sort the genes by alphabet 
final_genes_stage <- genes_to_test_stage[genes_to_test_stage %in% rownames(matrix_rho_stage)]
final_cancers_stage <- cancers_use_stage[cancers_use_stage %in% colnames(matrix_rho_stage)]

#sorted versions
matrix_rho_stage <- matrix_rho_stage[final_genes_stage, final_cancers_stage, drop = FALSE]
matrix_p_stage   <- matrix_p_stage[final_genes_stage, final_cancers_stage, drop = FALSE]

matrix_rho_plot_stage <- matrix_rho_stage
matrix_rho_plot_stage[is.na(matrix_rho_stage)] <- 0
```

## 2.7 Preparation of the final graph

```{r}
#adnotations-> annot_row creates a legend, assignment to classes
gene_classes_stage <- c(
  HDAC8="class I",
  HDAC3="class I",
  HDAC2="class I",
  HDAC1="class I",
  
  HDAC11="class IV",
  
  HDAC10="class IIB",
  HDAC6="class IIB",
  
  HDAC7="class IIA",
  HDAC9="class IIA",
  HDAC5="class IIA",
  HDAC4="class IIA",
  
  SIRT7="class III",
  SIRT2="class III",
  SIRT6="class III",
  SIRT4="class III",
  SIRT1="class III",
  SIRT3="class III",
  SIRT5="class III"
)
#data frame for heat map
annot_df_stage <- data.frame(
  gene = final_genes_stage,
  HDAC_family = gene_classes_stage[final_genes_stage])

#BH correction for many tests- reduces fake positives 
matrix_p_dot <- matrix(p.adjust(as.vector(matrix_p_stage), method = "BH"),
                       ncol = ncol(matrix_p_stage),
                       nrow = nrow(matrix_p_stage),
                       byrow = FALSE)

#adding markers depending on p value
display_matrix_stage <- 
  ifelse(matrix_p_dot < 0.001, "■",
  ifelse(matrix_p_dot < 0.01,  "▲",
  ifelse(matrix_p_dot < 0.05,  "•", "")))

#color palette
my_breaks_stage <- seq(-0.3, 0.3, length.out = 100)

my_colours_stage <- colorRampPalette(c("blue","white", "red"))(100)

# data preparation for ggplot 
df_long_stage <- matrix_rho_plot_stage %>%
  as.data.frame() %>%
  rownames_to_column("gene") %>%
  pivot_longer(-gene, names_to = "Cancer", values_to = "value")

df_long_stage$Cancer <- factor(df_long_stage$Cancer, levels = cancer_order_stage)

df_long_stage$label <- as.character(display_matrix_stage)

#adnotations panel
p_annot_stage <- ggplot(annot_df_stage, aes(
    x=1,
    y=factor(gene, levels=rev(final_genes_stage)),
    fill=HDAC_family)) +
  geom_tile() +
  scale_fill_manual(values=c(
    "class I"="salmon",
    "class IIA"="#E69F52",
    "class IIB"="#BDB600",
    "class III"="#009E60",
    "class IV"="#008ECE")) +
  scale_y_discrete(expand = c(0, 0)) + 
  scale_x_continuous(expand = c(0, 0)) +
  labs(y = "HDAC family", fill = "HDAC family") +
  theme_void() +
  theme(
    plot.margin = margin(t = 5.5, r = 0, b = 5.5, l = 5.5)
    ) +
  labs(fill = "HDAC family")


```

## 2.8 Drawing a graph

```{r}
p_heatmap_stage <- ggplot(df_long_stage,
                    aes(x=Cancer,
                        y=factor(gene, levels=rev(final_genes_stage)),
                        fill=value)) +
  geom_tile(color = "white", size = 0.2) +
  geom_text(aes(label=label), size=3, vjust = 0.75) +
  scale_fill_gradientn(colors=my_colours_stage, limits=c(-0.3,0.3), name = "rho value") + scale_y_discrete(expand = c(0, 0), position = "right") + 
  scale_x_discrete(expand = c(0, 0)) +
  theme_minimal(base_size=7) +
  theme(
    axis.text.x = element_text(angle=90, vjust=0.5, hjust = 1, color = "black"),
    axis.text.y = element_text(color = "black"),
    axis.title = element_blank(),
    panel.grid = element_blank(),
    plot.margin = margin(t = 5.5, r = 5.5, b = 5.5, l = 0),
    legend.position = "right"
  ) +
  labs(title="B: Stage ~ mRNA in TCGA tumors")


#heatmap + adnotations
final_plot_stage <- p_annot_stage + p_heatmap_stage +
  plot_layout(widths = c(1, 20), guides = 'collect') 

final_plot_stage
FIGURE 
```

## Save

```{r}
library(here)
here::here()
ggsave(
  filename = here("results", "05_heatmap_for_grade.png"),
  plot = final_plot,
  width = 8,
  height = 8
)
ggsave(
  filename = here("results", "05_heatmap_for_stage.png"),
  plot = final_plot_stage,
  width = 8,
  height = 8
)
```
